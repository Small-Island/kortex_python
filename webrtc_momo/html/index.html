<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="icon" type='image/png' href="../momo_icon.png">
    <style type="text/css">
    main div {
        margin: 0;
        padding: 0;
    }
    .VelocityStatus {
        float: left;
        width: 50%;
        background-color: #ddd;
    }
    .SegwayStatusStamped {
        float: right;
        width: 50%;
        background-color: #eee;
    }
    </style>
    <title>Momo P2P</title>
  </head>
  <body>
    <h3>Momo P2P</h3>
    <input type="button" onclick="connect();" id="connect" value="Connect">
    <input type="button" onclick="disconnect();" value="Disconnect">
    <video id="segway_control_dummy_video" style="display: none;"></video>
    <video id="haptics_dummy_video" style="display: none;"></video>
    <main>
        <div class="VelocityStatus">
            Send to Segway<br>
            <font size="4">
                <pre><div id="sgvs"></div></pre>
            </font>
            <br>
        </div>
        <div class="SegwayStatusStamped">
            Recieve from Segway <br>
            <font size="4">
                <pre><div id="sgss"></div></pre>
            </font>
            <br>
        </div>
    </main>
    <script type='text/javascript' src='./js/sora2022.3.1.js'></script>
    <script type='text/javascript' src='./js/localwebrtc.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script type="text/javascript">
        const debug = true;
        const sora = Sora.connection("ws://192.168.11.64:5000/signaling", debug);
        const options = {
            multistream: true,
            video: false,
            audio: true,
            dataChannelSignaling: true,
            dataChannels: [
                {
                    label: "#sora-devtools",
                    direction: "sendrecv"
                }
            ]
        };
        let recvonly_robots_control = sora.recvonly("robots-control", null, options);
        let recvonly_haptics = sora.recvonly('haptics', null, options);
        recvonly_robots_control.connect();
        recvonly_haptics.connect();

        recvonly_robots_control.on('message', (event) => {

            if ((new Uint8Array(event.data)[0] == 0x43 || new Uint8Array(event.data)[0] == 0x44 || new Uint8Array(event.data)[0] == 0x46 || new Uint8Array(event.data)[0] == 0x47 ) && event.data.byteLength == 4) {
                if (localrecvonly_segway.dataChannel) {
                    if (localrecvonly_segway.dataChannel.readyState == 'open') {
                        localrecvonly_segway.dataChannel.send(event.data);
                    }
                    else {
                        //localrecvonly_segway.connect();
                    }
                }
            }
            else if (new Uint8Array(event.data)[0] == 0xe0 && event.data.byteLength == 3) {
                if (localrecvonly_segway.dataChannel) {
                    if (localrecvonly_segway.dataChannel.readyState == 'open') {
                        localrecvonly_segway.dataChannel.send(event.data);
                    }
                    else {
                        //localrecvonly_segway.connect();
                    }
                }
            }
            else if (new Uint8Array(event.data)[0] == 0x99 && event.data.byteLength == 4) {
                if (localrecvonly_segway.dataChannel) {
                    if (localrecvonly_segway.dataChannel.readyState == 'open') {
                        localrecvonly_segway.dataChannel.send(event.data);
                    }
                    else {
                        //localrecvonly_segway.connect();
                    }
                }
            }
        });

        // setInterval(observe_CLOSE_DATA_CHANNEL, 5000);
        // function observe_CLOSE_DATA_CHANNEL() {
        //     if (!recvonly_robots_control.signalingSwitched) {
        //         recvonly_robots_control.connect();
        //     }
        //     if (!recvonly_haptics.signalingSwitched) {
        //         recvonly_haptics.connect();
        //     }
        //
        //     if (localrecvonly_segway.dataChannel) {
        //         if (localrecvonly_segway.dataChannel.readyState != 'open') {
        //             localrecvonly_segway.connect();
        //         }
        //     }
        //     else {
        //         localrecvonly_segway.connect();
        //     }
        //
        //     if (localrecvonly_haptics.dataChannel) {
        //         if (localrecvonly_haptics.dataChannel.readyState != 'open') {
        //             localrecvonly_haptics.connect();
        //         }
        //     }
        //     else {
        //         localrecvonly_haptics.connect();
        //     }
        // }

        onmessageHandler_segway = function (event) {
            if (new Uint8Array(event.data)[0] == 0x45 && event.data.byteLength == 20) {
                let segway_time_since_epoch = (new Int32Array([new Uint8Array(event.data)[1] << 24])[0] + new Int32Array([new Uint8Array(event.data)[2] << 16])[0] + new Int32Array([new Uint8Array(event.data)[3] << 8])[0] + new Int32Array([ new Uint8Array(event.data)[4]])[0] )/1000.0;
                let segway_lin_vel = (new Int32Array([new Uint8Array(event.data)[5] << 24])[0] + new Int32Array([ new Uint8Array(event.data)[6] << 16 ])[0] + new Int32Array([new Uint8Array(event.data)[7] << 8])[0] + new Int32Array([ new Uint8Array(event.data)[8]])[0] )/10000.0;
                let segway_ang_vel = (new Int32Array([new Uint8Array(event.data)[9] << 24])[0] + new Int32Array([ new Uint8Array(event.data)[10] << 16 ])[0] + new Int32Array([new Uint8Array(event.data)[11] << 8])[0] + new Int32Array([ new Uint8Array(event.data)[12]])[0] )/10000.0;
                let segway_latch = new Uint8Array(event.data)[13];
                let segway_turn_position = (new Int16Array([new Uint8Array(event.data)[14] << 8])[0] + new Int16Array([ new Uint8Array(event.data)[15]])[0] )/100.0;
                let segway_position_x = (new Int16Array([new Uint8Array(event.data)[16] << 8])[0] + new Int16Array([ new Uint8Array(event.data)[17]])[0] )/100.0;
                let segway_position_z = (new Int16Array([new Uint8Array(event.data)[18] << 8])[0] + new Int16Array([ new Uint8Array(event.data)[19]])[0] )/100.0;
                document.getElementById("sgss").innerHTML = 'latch ' + segway_latch + '\nturn position(deg) ' + segway_turn_position + '\nposition x(m) ' + segway_position_x + '\nposition z(m) ' + segway_position_z  + '\n時刻(s) ' + segway_time_since_epoch + '\n並進速度(m/s) ' + segway_lin_vel + '\n旋回速度(deg/s)' + segway_ang_vel;
            }
        };
        localrecvonly_segway = new localrecvonly('segway_control_dummy_video', 'ws://' + location.hostname + ':8080/ws', onmessageHandler_segway);
        localrecvonly_segway.connect();

        onmessageHandler_haptics = function (event) {
            if (event.data.byteLength == 461) {
                if (recvonly_haptics.signalingSwitched) {
                    recvonly_haptics.sendMessage('#sora-devtools', event.data);
                }
            }
        };
        localrecvonly_haptics = new localrecvonly('haptics_dummy_video', 'ws://' + location.hostname + ':8089/ws', onmessageHandler_haptics);
        localrecvonly_haptics.connect();

    </script>
  </body>
</html>
